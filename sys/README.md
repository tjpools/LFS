# /sys - Kernel and Device Information

## Purpose
A virtual filesystem (sysfs) that exposes information about devices, drivers, and kernel features. It provides a structured view of the kernel's device model.

## Key Characteristics
- **Virtual**: No actual files on disk (generated by kernel)
- **Hierarchical**: Organized device tree structure
- **Read/Write**: Can read device info and configure devices
- **Modern**: Replaces many /proc functions for hardware

## What is sysfs?

`sysfs` is a pseudo-filesystem that represents the kernel's unified device model:
- **Devices**: Physical and virtual devices
- **Buses**: PCI, USB, I2C, etc.
- **Drivers**: Device drivers
- **Classes**: Device classes (network, block, etc.)
- **Kernel features**: Power management, modules, etc.

## /sys vs /proc

| Directory | Purpose | Content |
|-----------|---------|---------|
| `/proc` | Process & system info | Processes, CPU, memory, network stats |
| `/sys` | Device & kernel info | Hardware devices, drivers, kernel objects |

**Simple rule**: 
- Need CPU info? → `/proc/cpuinfo`
- Need device info? → `/sys/class/`

## Main Structure

```
/sys/
├── block/          # Block devices (disks)
├── bus/            # System buses (pci, usb, etc.)
├── class/          # Device classes (net, input, etc.)
├── dev/            # Device numbers (major:minor)
├── devices/        # Device tree (all devices)
├── firmware/       # Firmware-specific data
├── fs/             # Filesystem info
├── kernel/         # Kernel configuration
├── module/         # Loaded kernel modules
└── power/          # Power management
```

## /sys/class/ - Device Classes

Devices organized by function:

### Network Devices
```
/sys/class/net/
├── eth0/           # Ethernet interface
│   ├── address     # MAC address
│   ├── mtu         # Maximum transmission unit
│   ├── operstate   # Up/down status
│   ├── speed       # Link speed
│   └── statistics/  # Traffic stats
├── lo/             # Loopback interface
└── wlan0/          # Wireless interface
```

### Block Devices
```
/sys/class/block/
├── sda/            # First hard drive
│   ├── size        # Size in sectors
│   ├── removable   # Is it removable?
│   ├── ro          # Read-only?
│   └── device/     # Link to device info
├── sda1/           # First partition
└── sr0/            # CD/DVD drive
```

### Input Devices
```
/sys/class/input/
├── mouse0/         # Mouse
├── event0/         # Input event device
└── keyboard/       # Keyboard
```

### Power Supply
```
/sys/class/power_supply/
└── BAT0/           # Battery (laptops)
    ├── capacity    # Battery percentage
    ├── status      # Charging/Discharging
    ├── voltage_now # Current voltage
    └── energy_full # Full capacity
```

### Backlight (Screen Brightness)
```
/sys/class/backlight/
└── intel_backlight/
    ├── brightness       # Current brightness
    ├── max_brightness   # Maximum value
    └── actual_brightness # Actual hardware value
```

## /sys/bus/ - System Buses

Bus types and connected devices:

### PCI Bus
```
/sys/bus/pci/
├── devices/        # PCI devices
│   └── 0000:00:00.0/
└── drivers/        # PCI drivers
    └── e1000e/     # Intel network driver
```

### USB Bus
```
/sys/bus/usb/
├── devices/        # USB devices
│   ├── usb1/       # USB root hub 1
│   └── 1-1/        # Device on port 1
└── drivers/        # USB drivers
    └── usb-storage/
```

## /sys/devices/ - Complete Device Tree

The full kernel device model:
```
/sys/devices/
├── pci0000:00/     # PCI root
│   ├── 0000:00:00.0/  # PCI device
│   └── 0000:00:1f.2/  # Another PCI device
├── platform/       # Platform devices
├── virtual/        # Virtual devices
└── system/         # System devices (CPU, memory)
```

## /sys/kernel/ - Kernel Features

Kernel configuration and tunables:

```
/sys/kernel/
├── debug/          # Debugging interfaces
├── mm/             # Memory management
│   ├── transparent_hugepage/
│   └── ksm/        # Kernel samepage merging
├── uevent_seqnum  # Current uevent sequence
├── vmcoreinfo      # Kernel crash dump info
└── security/       # Security modules
```

## /sys/module/ - Loaded Modules

Information about loaded kernel modules:
```
/sys/module/
├── e1000e/         # Intel network driver
│   ├── parameters/ # Module parameters
│   └── version     # Module version
└── ext4/           # ext4 filesystem
    └── parameters/
```

## Practical Examples

### 1. Check Network Interface Info
```bash
# MAC address
cat /sys/class/net/eth0/address

# Link status
cat /sys/class/net/eth0/operstate

# Speed (Mbps)
cat /sys/class/net/eth0/speed

# Statistics
cat /sys/class/net/eth0/statistics/rx_bytes
cat /sys/class/net/eth0/statistics/tx_bytes
```

### 2. Disk Information
```bash
# Disk size (in 512-byte sectors)
cat /sys/class/block/sda/size

# Convert to GB
echo $(($(cat /sys/class/block/sda/size) * 512 / 1024 / 1024 / 1024))

# Is it removable?
cat /sys/class/block/sda/removable  # 0=no, 1=yes

# Read-only?
cat /sys/class/block/sda/ro
```

### 3. Battery Status (Laptops)
```bash
# Battery percentage
cat /sys/class/power_supply/BAT0/capacity

# Charging status
cat /sys/class/power_supply/BAT0/status

# Power now (microwatts)
cat /sys/class/power_supply/BAT0/power_now
```

### 4. Screen Brightness
```bash
# Check current brightness
cat /sys/class/backlight/*/brightness

# Check maximum
cat /sys/class/backlight/*/max_brightness

# Set brightness (requires root)
echo 500 | sudo tee /sys/class/backlight/*/brightness
```

### 5. CPU Information
```bash
# Online CPUs
cat /sys/devices/system/cpu/online

# CPU frequency
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

# Available governors
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors

# Current governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

# Set governor
echo powersave | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
```

### 6. USB Devices
```bash
# List USB devices
ls /sys/bus/usb/devices/

# Device info
cat /sys/bus/usb/devices/*/product
cat /sys/bus/usb/devices/*/manufacturer
```

### 7. Module Parameters
```bash
# List module parameters
ls /sys/module/module_name/parameters/

# Check parameter value
cat /sys/module/snd_hda_intel/parameters/power_save

# Change parameter (temporary)
echo 1 | sudo tee /sys/module/snd_hda_intel/parameters/power_save
```

## Reading vs Writing

### Read-Only Files
Most files can only be read:
```bash
# Read network stats
cat /sys/class/net/eth0/statistics/rx_packets
```

### Writable Files
Some files can be modified (requires root):
```bash
# Enable/disable network interface
echo 1 | sudo tee /sys/class/net/eth0/carrier  # Up
echo 0 | sudo tee /sys/class/net/eth0/carrier  # Down

# Adjust LED brightness
echo 255 | sudo tee /sys/class/leds/input0::capslock/brightness
```

### Trigger Actions
Some writes trigger kernel actions:
```bash
# Unbind device from driver
echo "0000:02:00.0" | sudo tee /sys/bus/pci/drivers/e1000e/unbind

# Bind device to driver
echo "0000:02:00.0" | sudo tee /sys/bus/pci/drivers/e1000e/bind

# Rescan PCI bus
echo 1 | sudo tee /sys/bus/pci/rescan
```

## Common Use Cases

### Power Management
```bash
# Suspend to RAM
echo mem | sudo tee /sys/power/state

# Hibernation
echo disk | sudo tee /sys/power/state

# Check available sleep states
cat /sys/power/state
```

### CPU Frequency Scaling
```bash
# Get current frequency
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

# Set to performance mode
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Set to powersave mode
echo powersave | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
```

### Device Hot-plug
```bash
# Eject USB device safely
echo 1 | sudo tee /sys/block/sdb/device/delete

# Rescan SCSI bus for new devices
echo "- - -" | sudo tee /sys/class/scsi_host/host0/scan
```

## Tools That Use /sys

Many system tools read from `/sys`:

- `lspci` - PCI devices (reads /sys/bus/pci/)
- `lsusb` - USB devices (reads /sys/bus/usb/)
- `ethtool` - Network settings (reads /sys/class/net/)
- `sensors` - Hardware sensors (reads /sys/class/hwmon/)
- `udevadm` - Device management (uses /sys extensively)
- `systemd` - Many system controls via /sys

## udev and /sys

`udev` creates device nodes in `/dev` based on `/sys` information:

1. Kernel detects new device
2. Kernel creates `/sys` entries
3. Kernel sends uevent
4. udev receives uevent
5. udev creates `/dev` node
6. udev applies rules

## Hardware Monitoring

### Temperature Sensors
```bash
# Find sensors
ls /sys/class/hwmon/

# Read temperature (millidegrees Celsius)
cat /sys/class/hwmon/hwmon0/temp1_input

# Convert to Celsius
echo "scale=1; $(cat /sys/class/hwmon/hwmon0/temp1_input) / 1000" | bc
```

### Fan Speed
```bash
# Read fan RPM
cat /sys/class/hwmon/hwmon0/fan1_input

# Set fan speed (if supported)
echo 2500 | sudo tee /sys/class/hwmon/hwmon0/fan1_target
```

## LED Control

```bash
# List LEDs
ls /sys/class/leds/

# LED brightness
cat /sys/class/leds/*/brightness

# Turn on LED
echo 1 | sudo tee /sys/class/leds/input0::capslock/brightness

# Turn off LED
echo 0 | sudo tee /sys/class/leds/input0::capslock/brightness

# LED triggers (blink patterns)
cat /sys/class/leds/*/trigger
echo heartbeat | sudo tee /sys/class/leds/*/trigger
```

## Network Tuning

```bash
# Queue length
cat /sys/class/net/eth0/tx_queue_len
echo 2000 | sudo tee /sys/class/net/eth0/tx_queue_len

# MTU
cat /sys/class/net/eth0/mtu
echo 9000 | sudo tee /sys/class/net/eth0/mtu

# Carrier detection
cat /sys/class/net/eth0/carrier
```

## Troubleshooting

### Permission Denied
```bash
# Most read operations work as regular user
cat /sys/class/net/eth0/address

# Write operations need root
echo 1500 | tee /sys/class/net/eth0/mtu  # Fails
echo 1500 | sudo tee /sys/class/net/eth0/mtu  # Works
```

### Invalid Argument
```bash
# Trying to write invalid value
echo abc | sudo tee /sys/class/net/eth0/mtu
# tee: /sys/class/net/eth0/mtu: Invalid argument
```

### File Not Found
```bash
# Device doesn't exist
cat /sys/class/net/eth999/address
# cat: /sys/class/net/eth999/address: No such file or directory

# Device removed or name changed
```

## Security Considerations

⚠️ **Be Careful When Writing to /sys**:
- Can crash the system
- Can damage hardware (rare)
- Can disconnect devices
- Changes are immediate
- Most changes don't survive reboot

### Safe Practices
✅ Read before write
✅ Understand what you're changing
✅ Test on non-production systems
✅ Document changes
❌ Don't blindly write values
❌ Don't automate without testing

## Persistence

### Changes Don't Survive Reboot
```bash
# This is temporary
echo 500 | sudo tee /sys/class/backlight/*/brightness
# After reboot: back to default
```

### Make Changes Permanent

#### Via udev rules
```bash
# /etc/udev/rules.d/99-backlight.rules
ACTION=="add", SUBSYSTEM=="backlight", ATTR{brightness}="500"
```

#### Via systemd
```bash
# /etc/tmpfiles.d/brightness.conf
w /sys/class/backlight/intel_backlight/brightness - - - - 500
```

#### Via init script
```bash
# /etc/rc.local
echo 500 > /sys/class/backlight/*/brightness
```

## Summary

Key points about `/sys`:
- ✓ Virtual filesystem for hardware/kernel info
- ✓ Organized by device class, bus, and driver
- ✓ Read device information without special tools
- ✓ Write to configure devices (with root)
- ✓ Many system tools use /sys internally
- ✓ Works with udev for device management
- ✗ Changes usually don't persist across reboots
- ✗ Writing requires understanding of what you're doing
- ✗ Incorrect writes can cause system instability
